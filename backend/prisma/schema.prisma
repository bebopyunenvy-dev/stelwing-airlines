generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments

// 下面開始放大家的 schema
model userTest {
  id   Int    @id @default(autoincrement())
  name String
}

model Member {
  memberId     BigInt    @id @default(autoincrement()) @map("member_id")
  email        String    @unique @map("email") @db.VarChar(100)
  password     String    @map("password") @db.VarChar(255)
  firstName    String    @map("first_name")
  lastName     String    @map("last_name")
  gender       Gender    @map("gender")
  birthDate    DateTime? @map("birth_date")
  phone        String    @map("phone") @db.VarChar(20)
  address      String?   @map("address") @db.VarChar(255)
  avatarId     BigInt?   @map("avatar_id")
  level        Level     @default(basic) @map("level")
  points       Int       @default(0) @map("points")
  registerDate DateTime  @default(now()) @map("register_date")
  lastLogin    DateTime? @map("last_login")
  status       Status    @default(active) @map("status")
  remark       String?   @map("remark") @db.Text
  Booking      Booking[]

  @@map("members")
}

enum Gender {
  male
  female
  other
}

enum Level {
  basic
  silver
  gold
  vip
}

enum Status {
  active
  suspended
  deleted
}

model Country {
  countryId   BigInt @id @default(autoincrement()) @map("country_id")
  countryCode String @unique @map("country_code") @db.Char(2)
  countryName String @map("country_name") @db.VarChar(100)
  cities      City[]

  @@map("countries")
}

model City {
  cityId    BigInt    @id @default(autoincrement()) @map("city_id")
  cityName  String    @map("city_name")
  countryId BigInt    @map("country_id")
  country   Country   @relation(fields: [countryId], references: [countryId])
  airports  Airport[]

  @@map("cities")
}

model Airport {
  airportId   BigInt   @id @default(autoincrement()) @map("airport_id")
  airportCode String   @unique @map("airport_code") @db.Char(3)
  airportName String   @map("airport_name") @db.VarChar(150)
  cityId      BigInt   @map("city_id")
  city        City     @relation(fields: [cityId], references: [cityId])
  departures  Flight[] @relation("origin_airport")
  arrivals    Flight[] @relation("destination_airport")

  @@map("airports")
}

enum FlightStatus {
  SCHEDULED // 尚未起飛
  CANCELED // 已取消航班
}

/**
 * 時區規範：
 * - depTimeUtc / arrTimeUtc 一律儲存 UTC 時間（+00:00）
 * - flightDate 為航班當地日期（出發地當地時間）
 * - 前端顯示時請依照各城市時區轉換（例如 'Asia/Taipei', 'Asia/Tokyo'）
 */
model Flight {
  flightId        BigInt          @id @default(autoincrement()) @map("flight_id")
  flightNumber    String          @map("flight_number") @db.VarChar(6)
  flightDate      DateTime        @map("flight_date") @db.Date
  originIata      String          @map("origin_iata") @db.Char(3)
  destinationIata String          @map("destination_iata") @db.Char(3)
  depTimeUtc      DateTime?       @map("dep_time_utc") // UTC departure time
  arrTimeUtc      DateTime?       @map("arr_time_utc") // UTC arrival time
  status          FlightStatus    @map("status")
  origin          Airport         @relation("origin_airport", fields: [originIata], references: [airportCode])
  destination     Airport         @relation("destination_airport", fields: [destinationIata], references: [airportCode])
  BookingDetail   BookingDetail[]
  seatOptions     SeatOption[]

  @@map("flights")
}

model Booking {
  bookingId BigInt @id @default(autoincrement()) @map("booking_id")
  pnr       String @unique @db.VarChar(6)

  memberId BigInt? @map("member_id")
  member   Member? @relation(fields: [memberId], references: [memberId], onDelete: SetNull)

  firstName   String  @map("first_name")
  lastName    String  @map("last_name")
  gender      String? @map("gender")
  nationality String? @map("nationality") @db.Char(2)
  passportNo  String? @map("passport_no")

  cabinClass    String   @map("cabin_class")
  currency      String   @map("currency") @db.Char(3)
  totalAmount   Int      @map("total_amount")
  paymentStatus String   @map("payment_status")
  createdAt     DateTime @default(now()) @map("created_at")

  details BookingDetail[]

  @@map("bookings")
}

model BookingDetail {
  detailId  BigInt @id @default(autoincrement()) @map("detail_id")
  bookingId BigInt @map("booking_id")
  flightId  BigInt @map("flight_id")

  tripType String? @map("trip_type")

  seatId    BigInt? @map("seat_id")
  mealId    BigInt? @map("meal_id")
  baggageId BigInt? @map("baggage_id")

  createdAt DateTime @default(now()) @map("created_at")

  booking Booking        @relation(fields: [bookingId], references: [bookingId], onDelete: Cascade)
  flight  Flight         @relation(fields: [flightId], references: [flightId], onDelete: Restrict)
  seat    SeatOption?    @relation(fields: [seatId], references: [seatId], onDelete: SetNull)
  meal    MealOption?    @relation(fields: [mealId], references: [mealId], onDelete: SetNull)
  baggage BaggageOption? @relation(fields: [baggageId], references: [baggageId], onDelete: SetNull)

  @@index([bookingId])
  @@index([flightId])
  @@index([seatId])
  @@index([mealId])
  @@index([baggageId])
  @@map("booking_details")
}

model SeatOption {
  seatId      BigInt  @id @default(autoincrement()) @map("seat_id")
  flightId    BigInt  @map("flight_id")
  seatNumber  String  @map("seat_number") @db.VarChar(5)
  cabinClass  String  @map("cabin_class")
  isAvailable Boolean @default(true) @map("is_available")
  seatFee     Int     @default(0) @map("seat_fee")

  flight         Flight          @relation(fields: [flightId], references: [flightId], onDelete: Cascade)
  bookingDetails BookingDetail[]

  @@unique([flightId, seatNumber])
  @@map("seat_options")
}

model BaggageOption {
  baggageId      BigInt          @id @default(autoincrement()) @map("baggage_id")
  weightKg       Int             @map("weight_kg")
  fee            Int             @map("fee")
  currency       String          @default("TWD") @map("currency") @db.Char(3)
  bookingDetails BookingDetail[]

  @@unique([weightKg, currency])
  @@map("baggage_options")
}

model MealOption {
  mealId   BigInt  @id @default(autoincrement()) @map("meal_id")
  mealCode String  @unique @map("meal_code") @db.VarChar(10)
  mealName String  @map("meal_name") @db.VarChar(100)
  mealType String? @map("meal_type") @db.VarChar(30)
  mealFee  Int     @default(0) @map("meal_fee")
  currency String  @default("TWD") @map("currency") @db.Char(3)

  mealImagePath  String?         @map("meal_image_path") @db.VarChar(255)
  bookingDetails BookingDetail[]

  @@map("meal_options")
}

model Plan {
  id            BigInt   @id @default(autoincrement()) @map("id")
  userId        BigInt   @map("user_id")
  title         String   @map("title")
  destination   String?  @map("destination")
  startDate     DateTime @map("start_date")
  startTimezone String   @map("start_timezone")
  endDate       DateTime @map("end_date")
  endTimezone   String   @map("end_timezone")
  note          String?  @map("note") @db.Text
  coverImage    String?  @map("cover_image")
  isDeleted     Int      @default(0) @map("is_deleted")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("plan")
}
